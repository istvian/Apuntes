# Clase Lunes 2 de Junio 2025

## Uso de restricción ***Check***
Es cuando se validan los valores, Ej: decirle que valida los campos, edades entre 1 y 110.
Permite validar los datos que se ingresan en un insert o en un update. Por ejemplo, aceptar un rango de valores en un precio o para una nota.


### Crear tabla de ejemplo
```SQL
CREATE TABLE RegistroDeNotas(
codRegistro number(5) not null primary key,
codAsignatura varchar2(6),
rutEstudiante varchar2(10),
numEvaluacion number(1),
nota number(2,1) --- Es para decimales, 2 digitos y 1 decimal => 7.0
);

DESCRIBE REGISTRODENOTAS;
```

### Sintaxis
```sql
ALTER TABLE <NOMBRETABLA>
ADD CONSTRAINT <NOMBRECHECK>
CHECK(<EXPRESIONCHECK>)
```

### Ejemplo

```SQL
--- ESTA RESTRICCIÓN CHECK VALIDARÁ QUE EL NÚMERO DE EVALUACIÓN SEA ENTRE 1 Y 4
ALTER TABLE REGISTRODENOTAS
ADD CONSTRAINT CKNUMEVAL
CHECK(NUMEVALUACION>=1 AND NUMEVALUACION<=4)
```

> [!TIP]
> Al ejecutar una restricción check, fallará si ya hay un dato no válido en la tablam por ejemplo, si se había ingresado en número de evaluación 5 entonces marcaría error al tratar de crear la restricción check.
> Ojala crear el **check** al crear la tabla

Ahora insertaremos registros en la tabla REGISTRODENOTAS

```sql
INSERT INTO REGISTRODENOTAS VALUES(124,'SD7099', '21454780-9',1,5.6);
SELECT * FROM REGISTRODENOTAS;
```

No se cumple el check y se vulnera el chequeo, por lo que lanza error

```SQL
INSERT INTO REGISTRODENOTAS VALUES(125,'FR4545', '20210656-3',5,6.5);
--- Error que empieza en la línea: 19 del comando :
--- INSERT INTO REGISTRODENOTAS VALUES(125,'FR4545', '20210656-3',5,6.5)
--- Informe de error -
--- ORA-02290: check constraint (SYSTEM.CKNUMEVAL) violated
```

## Eliminar la restricción Check

```sql
ALTER TABLE REGISTRODENOTAS DROP CONSTRAINT CKNUMEVAL;
```

> [!TIP]
> Para encontrar el nombre de la restricción o Constraint se utiliza

```sql
SELECT * FROM user_constraints WHERE table_name = 'REGISTRODENOTAS';
```

![image](https://github.com/user-attachments/assets/6f6afd37-bbab-4d24-a92c-af1cb04e1be3)

Nota: Para modificar un ***check*** hay que eliminarlo y agregar uno nuevo


## Ejercicio
Crear una restricción ***check*** para validar las notas entre 1 y 7

```sql
ALTER TABLE REGISTRODENOTAS
ADD CONSTRAINT CKNOTAS
CHECK(NOTA>=1 AND NOTA<=7);
```

Al intentar agregar una nota superior a 7:

```sql
INSERT INTO REGISTRODENOTAS VALUES(1,'ABCDEF', '12345678-9',2,8);
--- Error que empieza en la línea: 30 del comando :
--- INSERT INTO REGISTRODENOTAS VALUES(1,'ABCDEF', '12345678-9',2,8)
--- Informe de error -
--- ORA-02290: check constraint (SYSTEM.CKNOTAS) violated
```

Al ingresar una nota entre 1 y 7:

```sql
INSERT INTO REGISTRODENOTAS VALUES(1,'ABCDEF', '12345678-9',2,6.2);
--- 1 fila insertada
```

## Transacciones

Cuando queremos ejecutar varias instrucciones a la vez. Bloques de transacciones, pero eso tiene un riesgo. Por defecto los motores de base de datos no tienen <kbd>Ctrl</kbd> + <kbd>Z</kbd>
A veces no se ejecuta todo el bloque y se ejecuta solo una porción.
Si quiero ejecutar un bloque de instrucciones hay ejecutarlo dentro de una *transacción* y en caso de que falle algo, se deshacen todos los cambios.

### Comandos TCL (Transaction Control Language)
Una transacción es un conjunto de operaciones DML (para insert, delete y update)

> [!IMPORTANT]
> Si una de las operaciones falla se podrá deshacer la transacción entera

#### *COMMIT*
Confirma la ejecución de una transacción

#### *ROLLBACK*
Es una reversión que permite deshacer una transacción

### Tabla de ejemplo:

```sql
CREATE TABLE PRODUCTOS(
CODPROD NUMBER(4) NOT NULL PRIMARY KEY,
NOMBREPROD VARCHAR2(20),
PRECIO NUMBER(8),
PESO NUMBER(5,2),
FECHAFABR DATE
);
DESCRIBE PRODUCTOS;
```

![image](https://github.com/user-attachments/assets/b279d765-9d4b-434a-8a6f-27b1bc0cff9d)
