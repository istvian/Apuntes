
# Unidad 2: Consultas avanzadas en una o más tabla
#### Script

```sql
create table Camioneros(
RutCamionero varchar2(12) not null primary key,
NomCam varchar2(20),
ApPatCam varchar2(20),
ApMatCam varchar2(20),
FonoCam varchar2(10),
Sueldo number(9)
);
Create table Camiones(
Patente varchar2(6) not null primary key,
Marca varchar2(20),
Modelo varchar2(20),
Color varchar2(15),
Año number(4)
);
Create table ClienteDestino(
RutCliente varchar2(12) not null primary key,
NomCli varchar2(30),
ApPatCli varchar2(20),
ApMatCli varchar2(20),
FonoCli varchar2(10)
);
Create table Encomiendas(
CodEncomienda number(8) not null primary key,
PesoGr number(5),
Costo number(6),
Ciudad varchar2(30),
FechaEnvio date,
RutCli varchar2(12) not null references clientedestino,
RutCam varchar2(12) not null references camioneros,
Patente varchar2(6) not null references camiones
);

insert into camioneros values('10546789-4','Juan','Lara','Soto','64758999' ,340000);
insert into camioneros values('11328988-0','Mario','Donoso','Vera','53647800',350000);
insert into camioneros values('10324879-3','Luis','Díaz','Castro','43769034',340000);
insert into camioneros values('9678321-7', 'Mario','Donoso','Zapata','32879980',350000);

insert into camiones values('CTFT45','Ford','Cargo','Blanco',2010);
insert into camiones values('DFGR35','Mercedes Benz','Zetros','Negro',2011);
insert into camiones values('DRTQ87','Renault','Maxity','Blanco',2010);

insert into clienteDestino values('12867967-2','Carolina','Riquelme','Duarte','947528596');
insert into clienteDestino values('13437856-1','Eliana','Godoy','Urrutia','939881765');
insert into clienteDestino values('9768345-6','Carlos','Núñez','Torres','965639011');
insert into clienteDestino values('10769800-6','Paula','Millar','Salas','985619675');
insert into clienteDestino values('11341560-k','Marco','Vera','Carrillo','992039100');
insert into clienteDestino values('20900289-2','Lorena','Parra','Mora','945879826');

insert into encomiendas values(1,2380,52000,'Calama','13/10/2023','13437856-1','11328988-0','CTFT45');
insert into encomiendas values(2,1450,75000,'Arica','22/10/2023','12867967-2','10546789-4','DFGR35');
insert into encomiendas values(3,2130,23000,'Curicó','25/10/2023','9768345-6','9678321-7','CTFT45');
insert into encomiendas values(4,1569,30000,'Valdivia','25/10/2023','12867967-2','10324879-3','DRTQ87');
insert into encomiendas values(5,2176,25000,'Santiago','26/10/2023','13437856-1','11328988-0','DFGR35');
insert into encomiendas values(6,3343,28000,'Santiago','27/10/2023','11341560-k','10546789-4','DRTQ87');
insert into encomiendas values(7,2330,28000,'Curicó','3/11/2023','9768345-6','9678321-7','DRTQ87');
insert into encomiendas values(8,5890,56000,'Valdivia','5/11/2023','12867967-2','10324879-3','CTFT45');
insert into encomiendas values(9,8750,65000,'Arica','7/11/2023','12867967-2','11328988-0','DRTQ87');
insert into encomiendas values(10,8906,45000,'Santiago','11/11/2023','10769800-6','10546789-4','CTFT45');
insert into encomiendas values(11,8130,33000,'Curicó','12/11/2023','9768345-6','11328988-0','DRTQ87');
insert into encomiendas values(12,5680,62000,'Calama','13/11/2023','20900289-2','9678321-7','DFGR35');
insert into encomiendas values(13,4530,38000,'Curicó','15/11/2023','9768345-6', '11328988-0','DFGR35');
insert into encomiendas values(14,9890,66000,'Valdivia','17/11/2023','12867967-2','9678321-7','DRTQ87');
insert into encomiendas values(15,3976,45000,'Santiago','17/11/2023','13437856-1','10546789-4','DFGR35');
insert into encomiendas values(16,5460,65000,'Arica','20/11/2023','12867967-2','10546789-4','CTFT45');
insert into encomiendas values(17,5900,67000,'Calama','21/11/2023','20900289-2','9678321-7','CTFT45');
insert into encomiendas values(18,7866,58000,'Curicó','22/11/2023','9768345-6', '11328988-0','DFGR35');
insert into encomiendas values(19,7800,56000,'Valdivia','24/11/2023','12867967-2','9678321-7','CTFT45');
insert into encomiendas values(20,4890,35000,'Santiago','25/11/2023','13437856-1','10546789-4', 'DRTQ87');
insert into encomiendas values(21,7800,75000,'Arica','25/11/2023','12867967-2','9678321-7','CTFT45');
insert into encomiendas values(22,6080,68000,'Calama','26/11/2023','20900289-2','11328988-0','DRTQ87');
insert into encomiendas values(23,8945,64000,'Curicó','27/11/2023','9768345-6','10546789-4','DFGR35');
insert into encomiendas values(24,9800,43000,'Valdivia','28/11/2023','12867967-2','10324879-3','CTFT45');
insert into encomiendas values(25,6800,45000,'Santiago','29/11/2023','13437856-1','11328988-0', 'DRTQ87');

```


## Funciones de una sola fila

### 1) Manipulación de caracteres

Son las funciones que permiten manipular como string(cadenas) los datos de las tablas. 

---

#### Concat
Concatena (une) dos elementos.

Ejemplo:

```sql
SELECT CONCAT('Hoy es ', sysdate) FECHA FROM DUAL;

SELECT CONCAT(MARCA, MODELO) FROM CAMIONES;

SELECT DISTINCT CONCAT('Cliente De Ciudad=', CIUDAD) CLIENTES FROM ENCOMIENDAS;

```

No puede concatenar más de 2 elementos

#### Operador ||

También concatena, y además puede hacerlo con más de dos datos a la vez

```sql

SELECT PATENTE || ' es ' || color || ' y es del año ' || año Camiones from camiones;

SELECT DISTINCT 'El cliente ' || rutcli || ' envio desde ' || ciudad Datos from encomiendas;

SELECT DISTINCT UPPER(CIUDAD) ENVIOS_DESDE FROM ENCOMIENDAS;
```

> ![NOTE]
> El DISTINCT toma todos los campos y hace que no se repitan, en este caso el par de rut y ciudad no se repiten

#### INITCAP

Deja la inicial en Mayuscula

```SQL
SELECT 'El camión ' || initcap(patente) || ' es del año ' || año Dato from camiones;
```

##### LPAD y RPAD

Retorna una cadena de largo n, comenzando desde la cadena1. Si n es mayor que el largo de la cadena1, hace un relleno

L = Left
R = Right

```SQL
SELECT LPAD(FONOCAM, 12, '+569') FONO FROM CAMIONEROS;

SELECT RPAD(PESOGR, 7, ' gr') PESO FROM ENCOMIENDAS;
```

##### TRIM

Le quita el espacio a los textos

```SQL
SELECT TRIM(' PATENTE= ') DATO, PATENTE FROM CAMIONES;
```

##### REPLACE

Reemplaza en pantalla un texto

```SQL
SELECT REPLACE(FECHAENVIO, '/', '-') FECHA, CODENCOMIENDA FROM ENCOMIENDAS;
```

##### SUBSTR

Muestra parte de una cadena, un segmento, un substring

```sql
SELECT SUBSTR(FECHAENVIO, 4,2) MES, CODENCOMIENDA FROM ENCOMIENDAS;
```

### EJERCICIO PROPUESTO

Mostrar fechas y costos de envío del mes de noviembre con el siguiente formato.

```SQL

SELECT 'El día ' || FECHAENVIO || ' se hizo un envio por $' || costo FECHAS_Y_COSTOS from ENCOMIENDAS WHERE fechaenvio LIKE '%/11/%' ORDER BY FECHAENVIO;

SELECT 'El día ' || FECHAENVIO || ' se hizo un envio por $' || costo FECHAS_Y_COSTOS from ENCOMIENDAS WHERE SUBSTR(FECHAENVIO, 4,2) = '11' ORDER BY FECHAENVIO;

```

##### INSTR

Busca una cadena y nos indica en que posición esta

```sql
SELECT 'GR en ' || patente, instr(patente, 'GR') Está_en from camiones;

-- MUESTRA SOLO DONDE ESTÁ
SELECT 'GR en ' || patente, instr(patente, 'GR') Está_en from camiones WHERE INSTR(PATENTE, 'GR') !=0;
SELECT 'GR en ' || patente, instr(patente, 'GR') Está_en from camiones WHERE INSTR(PATENTE, 'GR') >0;

```

##### LENGTH 

Muestra el largo de la palabra
```SQL
SELECT LENGTH('sqldeveloper') DATO FROM DUAL;

SELECT MARCA,LENGTH(MARCA) LARGO_DE_MARCA FROM CAMIONES;
```

---


## 1) Funciones de Números

#### Script
```sql
create table Productos(
codP varchar2(7) not null primary key,
nomP varchar2(20),
fechaFabr date,
precioProveedor number(10,2),
precioVenta number(10,2),
peso number(6,2)  -- en kg
);

Create table Vendedores(
codV varchar2(6) not null primary key,
nombres varchar2(15),
apPat varchar2(10),
apMat varchar2(10),
fechaNac date,
sueldoBase number(7)
);

Create table Ventas(
numVenta number(8) not null primary key,
monto number(12,2),
fecha date,
codProd varchar2(7) not null references Productos,
codVend varchar2(6) not null references Vendedores
);

insert into Productos values('bbr2325','Motor tipo A','12/5/2021',250000,270000,93.56);
insert into Productos values('bbr2346','Motor tipo B','26/6/2021',280000,310000,113.49);
insert into Productos values('bbr2357','Motor tipo C','12/5/2021',220000,250000,87.23);
insert into Productos values('dte4387','Inyector central','24/3/2021',90000,95000,2.56);
insert into Productos values('dte2600','Inyector secuencial','25/5/2021',134000,140000,3.79);
insert into Productos values('ytd2380','Válvula de flujo','8/4/2021',19000,23000,0.28);
insert into Productos values('ytd4578','Válvula zenner','17/5/2021',26000,30000,0.72);
insert into Vendedores values('34RT','Romina', 'Zapata', 'Aburto','19/8/1989',430431);
insert into Vendedores values('28DS','Franco', 'Munita', 'Vera','2/12/1988',416389);
insert into Vendedores values('21FD','Carla', 'Millar', 'Gatica','26/10/1996',383897);
insert into Vendedores values('54DE','Renato', 'Donoso','Santis','16/8/1994',425675);
insert into Ventas values(78,1200560,'15/7/2021','dte4387', '21FD');
insert into Ventas values(79,906790,'16/7/2021','ytd2380', '28DS');
insert into Ventas values(80,1890500,'19/7/2021','bbr2346', '34RT');
insert into Ventas values(81,980450,'20/7/2021','ytd4578', '54DE');
insert into Ventas values(82,1105020,'24/7/2021','dte2600', '28DS');
insert into Ventas values(83,2450600,'25/7/2021','bbr2325', '34RT');
insert into Ventas values(84,1670400,'2/8/2021','ytd4578', '21FD');
insert into Ventas values(85,1540710,'5/8/2021','dte4387', '54DE');
insert into Ventas values(86,987600,'9/8/2021','bbr2357', '34RT');
insert into Ventas values(87,1346900,'12/8/2021','dte2600', '21FD');
insert into Ventas values(88,1200780,'21/8/2021','ytd2380', '28DS');
insert into Ventas values(89,1790430,'27/8/2021','ytd4578', '54DE');
insert into Ventas values(90,2800910,'1/9/2021','bbr2346', '21FD');
insert into Ventas values(91,995500,'16/9/2021','ytd2380', '34RT');
insert into Ventas values(92,1250400,'20/9/2021','dte4387', '28DS');
insert into Ventas values(93,1320650,'1/10/2021','bbr2357', '54DE');
insert into Ventas values(94,1540300,'5/10/2021','dte2600', '21FD');

```

Estás funciones permiten hacer formulas, redondear, etc

Ejemplo:

```SQL

SELECT PRECIOVENTA - PRECIOPROVEEDOR DIFERENCIA FROM PRODUCTOS;

SELECT 'RESTA DE PRECIOS DEL ' || NOMP || '=' || (PRECIOVENTA-PRECIOPROVEEDOR) DIF FROM PRODUCTOS;

SELECT 'SUELDO BASDE DE ' || NOMBRES || ' DIVIDIDO POR 1000=' || SUELDOBASE/1000 DATO FROM VENDEDORES;

SELECT NOMP || ' PESA= ' || PESO * 1000 || ' GR' PESO FROM PRODUCTOS;


```

#### EJERCICIO PROPUESTO

CALCULAR Y MOSTRAR UN BONO DE 5% DEL SUELDO BASE PARA CADA VENDEDOR, CON EL SIGUIENTE FORMATO DE SALIDA:

```SQL
SELECT 'BONO PARA ' || NOMBRES || '=' || (SUELDOBASE*.05) BONO FROM VENDEDORES;
```

#### MOD

Obtiene el modulo de la división

```sql
-- Divide el sueldo por 1000 y obtiene el resto
SELECT MOD(SUELDOBASE, 1000) RESTO FROM VENDEDORES;
```

#### ROUND
Redondea el resultado

```sql
SELECT PRECIOVENTA/PRECIOPROVEEDOR DIV FROM PRODUCTOS;

SELECT ROUND(PRECIOVENTA/PRECIOPROVEEDOR,2) DIV FROM PRODUCTOS;
```

#### TRUNC
Devuelve el valor sin decimales

```sql
SELECT TRUNC(PESO) PESO FROM PRODUCTOS;
```

## Funciones de fechas
Manipular fechas, mostrar, restar, sacar, etc

#### SYSDATE

Devuelve la fecha actual del computador

```sql
SELECT SYSDATE FROM DUAL;

SELECT SYSTIMESTAMP FROM DUAL;
```

<img width="331" height="107" alt="image" src="https://github.com/user-attachments/assets/c4387596-f156-4c4c-85f0-b45f6902f6c2" />

#### RESTAR FECHAS
Sirve para ver fechas de vencimiento, etc. Retorna días

```SQL
SELECT TRUNC(SYSDATE-FECHAFABR) DIF FROM PRODUCTOS;
```

#### EJERCICIO PROPUESTO

Devolver los días transcurridos desde la fecha de venta con el formato:


```sql
SELECT 'Desde el ' || FECHA || ' han pasado '|| TRUNC(SYSDATE-FECHA)|| ' días' TIEMPO FROM VENTAS;
```

#### EXTRACT

```sql
SELECT EXTRACT(MONTH FROM FECHA) MES FROM VENTAS;

SELECT EXTRACT(DAY FROM FECHA) MES FROM VENTAS;

SELECT EXTRACT(YEAR FROM FECHA) MES FROM VENTAS;
```

#### MONTHS_BETWEEN

Devuelve la cantidad de meses de diferencia entre dos fechas

```sql
SELECT ROUND(MONTHS_BETWEEN(MAX(FECHA), MIN(FECHA))) MESES FROM VENTAS;


```
