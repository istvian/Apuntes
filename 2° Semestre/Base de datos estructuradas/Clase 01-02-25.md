# Procedimientos PL/SQL con procedimientos almacenados (stored procedure sp) y Funciones almacenadas (stored function sf)

Subprogramas o bloque PL/SQl. Pueden ser llamados junto a parametros. Es posible declarar y definir un subprograma. Dentro de las partes encontramos una especificacion.

## SP y SF
Las funciones tienen que tener un return

# SP
Ejemplo:
<img width="1365" height="427" alt="image" src="https://github.com/user-attachments/assets/4143aa35-4dca-482e-aedc-c892a20868f2" />

```sql
set serveroutput on;
```

```sql
create or replace procedure sp1
as
mensaje varchar2(7):='hoy es ';   /* tipo texto */

begin
dbms_output.put_line(mensaje||sysdate);
end;
<img width="1055" height="465" alt="image" src="https://github.com/user-attachments/assets/7108aeff-ce85-486c-9cf6-ebd37b41492b" />

```

Hacer eso se llama compilar

<img width="256" height="110" alt="image" src="https://github.com/user-attachments/assets/59c0bc74-d508-4fdf-90f5-ccad99976c62" />

Para ejecutar 

```sql
exec sp1
```

Salida:  
<img width="439" height="184" alt="image" src="https://github.com/user-attachments/assets/730392e9-6d22-4825-a9e7-c20c4c611646" />

Para ver procedimientos hay:


```sql
select object_name
from user_procedures
where object_type='PROCEDURE'
<img width="1125" height="338" alt="image" src="https://github.com/user-attachments/assets/8257cefc-7276-4907-95f8-4603d9220493" />

```

<img width="333" height="123" alt="image" src="https://github.com/user-attachments/assets/b7455b25-1041-4e1d-90d5-1ea406078bf0" />

Para eliminar un procedimiento:
```sql
drop procedure sp1
```

## Ejemplo 2:

Crearemos un sp (procedimiento almacenado) ejemplo2 que imprimirá una fecha y luego se creará un sp que imprimirá un mensaje y llamará  al procedimiento ejemplo2.

```sql
-- Crea un procedimiento
create or replace procedure sp2
as
fecha date:='12/6/2022';
monto number(6):=250000;

begin
dbms_output.put_line(fecha||'->'||monto);
end;

-- Lo ejecuta
exec sp2;

-- Crea un procedimiento que llama a SP2
create or replace procedure llamaSp2
as
mensaje varchar2(20):='Ventas del día:';

begin
dbms_output.put_line(mensaje);
sp2;
end;

-- Ejecuta 
exec llamasp2;

```

<img width="407" height="271" alt="image" src="https://github.com/user-attachments/assets/5a8d0717-15a8-443d-8e32-c7032ab5ed62" />

## EJEMPLO 3

```SQL

-- CARGAR SCRIPT
-- CREA TABLAS
create table vestuario(
codVest varchar2(5) not null primary key,
descripcion varchar2(20),
precio number(8),
stock number(3)
);

create table ventafinal(
numVenta number(8) not null primary key,
fecha date,
cantVendida number(3),
codigoVest varchar2(5) not null references vestuario
);

-- CREA SECUENCIA
create sequence sec_ven
start with 1;

-- INSERTA
insert into vestuario values('v2089','short',10000,35);
insert into vestuario values('v2097','polera',25000,50);
insert into vestuario values('v2102','pantalón',15000,40);
insert into vestuario values('v2155','camisa',20000,18);
insert into vestuario values('v2209','blusa',28000,40);
insert into ventafinal values(sec_ven.nextval,'11/11/2021',10,'v2097');
update vestuario set stock=stock-10 where codvest='v2097';
insert into ventafinal values(sec_ven.nextval,'17/11/2021',5,'v2089');
update vestuario set stock=stock-5 where codvest='v2089';
insert into ventafinal values(sec_ven.nextval,'26/11/2021',6,'v2097');
update vestuario set stock=stock-6 where codvest='v2097';
insert into ventafinal values(sec_ven.nextval,'27/11/2021',6,'v2155');
update vestuario set stock=stock-6 where codvest='v2155';
insert into ventafinal values(sec_ven.nextval,'29/11/2021',5, 'v2209');
update vestuario set stock=stock-5 where codvest='v2209';
insert into ventafinal values(sec_ven.nextval,'30/11/2021',15, 'v2097');
update vestuario set stock=stock-15 where codvest='v2097';

delete from vestuario where codvest='v2102';

select * from vestuario;

--CREA PROCEDIMIENTO SP3 QUE AUMENTA EN 50% EL PRECIO DE LAS CAMISAS
create or replace procedure sp3
as
 begin
  update vestuario set precio=precio*1.5
  where codvest ='v2155';
 end;

exec sp3;

select * from vestuario;

```
ANTES:  
<img width="541" height="211" alt="image" src="https://github.com/user-attachments/assets/be27f731-3933-4925-95ea-930dffa8e8b5" />
DESPUES:  
<img width="556" height="200" alt="image" src="https://github.com/user-attachments/assets/ff31755b-cf26-4eb2-9fc5-5d895e997e89" />

## EJEMPLO 4

```SQL
create or replace procedure sp4
as
 begin
-- INSERTA 6 PRODUCTOS A VENTA Y BAJA DE STOCK 6
  insert into ventafinal values(sec_ven.nextval,'2/12/2021',6,'v2097');
  update vestuario set stock=stock-6 where codvest='v2097';
 end;

-- SI COMPILAMOS Y EJECUTAMOS

EXEC SP4;
select * from ventafinal;
select * from vestuario;
-- Se ve reflejado en los selects
```

## EJEMPLO 5

```SQL
create or replace procedure sp_stock as
begin  
   dbms_output.put_line('Resultado');
   for vRow in (select codvest,descripcion,stock from vestuario) 
    loop   /* se mantiene imprimiendo */
         dbms_output.put_line(
	     'Del vestuario '||vRow.codvest||'-'||vRow.descripcion||'  quedan= '||vRow.stock);
    end loop;
end;

-- IMPRIME RESULTADO
-- HACE UN FOR
-- vRow es un nombre que uno quiera
-- Dentro del for usa un loop
-- Muestra los campos de la tabla

exec sp_stock;
```
<img width="356" height="169" alt="image" src="https://github.com/user-attachments/assets/a2929060-9833-473b-967e-a937fe352844" />



