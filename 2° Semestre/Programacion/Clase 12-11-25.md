# Consumo de servicios externos

## Definición:
La integración con servicios externos se refiere a que diferentes servicios web, sistemas y software de aplicación se conecten entre sí y compartan datos.  

Las aplicaciones, entre ellas, pueden consumir web service, independiente del sistema operativo o tecnologia.  

La mayoria de las empresas han aumentado sus requerimientos por aplicaciones externas  

Para lograr la integración se necesita una interfaz (API= Application Programming Interface = Interfaz de programación de aplicaciones)  

Permite la conexión entre aplicaciones a través de bibliotecas que son usadas entre dos aplicaciones. O sea, es un "canal" que es usado por todos y no es necesario reescribirlo cada vez que se necesite ocupar.  

Por ejemplo: Construiremos una página web, usando PHP, la cual será nuestra API  

Las aplicaciones web, utilizan las APIs interactuan usando el HTTP.

#### Software a utilizar
- PHP
- MySQL
- Python

PHP = Hypertext Preprocessor  

## Usando PHP

Ejemplo

```php
<!DOCTYPE html>
<html lang="es"> <!-Comienza el código html->
  <head>
    <title>Prueba de PHP</title>
  </head>
  <body>
    <?php #Comienza el código php
    echo "<p>Hola Mundo</p>"; 
    ?>
  </body>
</html>
```

Hay que guardar el archivo en el servidor Apache en una carpeta especifica.

***C:\AppServ\www\ej1\index.php***

Borramos todo excepto el php

```php
<?php #Comienza el código php
echo "<p>Hola Mundo</p>";
?>
```

## PHP

### Variables
Las variables comienzan con el simbolo $  

Ejemplo:

```php
<?php
echo "<p>Cálculo de IVA</p>\n";
$monto = 20000;
echo "<p>Monto inicial=" . $monto . "</p>\n";
$montoFinal = $monto * 1.19;
echo "Total con IVA=" . $montoFinal;
?>
```

## JSON (Javascript Object Notation)

Es un formato de texto ligero para el intercambio de datos y es independiente de cualquier lenguaje de programación. Reduce el tamaño de los archivos y el volumen de datos que es necesario transmitir.  

Ejemplo: Utilizaremos una matriz o array en php y la mostraremos en JSON

```php
<?php
$array4 = array(
  array("num.fact." => 2334557, "rut cli." => "11345324-5", "monto" => 45000),
  array("num.fact." => 2334558, "rut cli." => "11222333-4", "monto" => 34000),
);
print_r(json_encode($array4));
?>
```

```json
[
    {
        "num.fact.": 2334557,
        "rut cli.": "11345324-5",
        "monto": 45000
    },
    {
        "num.fact.": 2334558,
        "rut cli.": "11222333-4",
        "monto": 34000
    }
]
```
Entrega una ***lista*** con ***diccionarios***

JSON es un tipo de formato de presentación, usado para el intercambio de datos, que nos servira más adelante.  

Ahora usaremos MYSQL para crear una tabla y luego la leeremos desde PHP, para traer sus datos y mostrarlos en formato JSON.


### Crear base de datos
```sql
create database empresa;
use empresa;

create table ventafact(
numfact int primary key,
fechafact date,
rutcli varchar(10),
monto float
)engine=innodb;
insert into ventafact values(3420089,'2023/03/5','11454980-k',56000);
insert into ventafact values(3420090,'2023/03/12','10499891-2',89000);
insert into ventafact values(3420091,'2023/03/22','11450081-7',120000);
```

### Crear php
Para conectarnos a la tabla y generar una salida tipo json

```php
<?php
$host = "localhost";
$user = "root";
$pass = "12345678";
$dbname = "empresa";
try {
    $con = new PDO("mysql:host=$host;dbname=$dbname", $user, $pass);
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $ex) {
    echo ($ex);
    die($ex->getMessage());
}
$sql1 = "select * from ventafact";
$stmt = $con->prepare($sql1);
$stmt->execute();
$registros = array();
while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $registros[] = $row;
}
print_r(json_encode($registros));
?>

```


<img width="1869" height="146" alt="image" src="https://github.com/user-attachments/assets/c01c5ae5-8cdf-471c-9c19-b0188647d595" />

Hay que instalar la biblioteca request

```bash
pip install requests
```
Ahora hay que crear un archivo python


```python
import json
import requests


respuesta = requests.get("http://localhost/ej1/conecta.php")
result = respuesta.json()
print(json.dumps(result, indent=4))
```


Serializar = Convertir un objeto a Json
Desserializar = De Json a una tabla

Otro ejemplo 

```python
import json
import requests

respuesta = requests.get("https://api.gael.cloud/general/public/sismos")
result = respuesta.json()
print(json.dumps(result, indent=4))
```
